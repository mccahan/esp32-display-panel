<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 Display Manager</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>ESP32 Display Manager</h1>
      <p>Configure and manage your smart display panels</p>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="devices">Displays</div>
      <div class="tab" data-tab="scenes">Scenes</div>
      <div class="tab" data-tab="discover">Discover</div>
      <div class="tab" data-tab="plugins">Plugins</div>
      <div class="tab" data-tab="settings">Settings</div>
    </div>

    <!-- Devices Tab -->
    <div id="tab-devices">
      <div class="main-layout">
        <!-- Device List Sidebar -->
        <div class="device-sidebar">
          <div class="card">
            <h2>My Displays</h2>
            <div class="device-list" id="device-list">
              <div class="empty-state">Loading displays...</div>
            </div>
          </div>
        </div>

        <!-- Device Detail Panel -->
        <div id="device-detail" class="hidden">
          <div class="card">
            <div class="section">
              <div class="section-title">Display Settings</div>
              <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="device-name" placeholder="Enter device name">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Theme</label>
                  <select id="device-theme" onchange="onDeviceThemeChange(this.value)">
                    <option value="auto">Auto Light/Dark</option>
                    <option value="dark_mode">Dark Mode</option>
                    <option value="light_mode">Light</option>
                    <option value="neon_cyberpunk">Neon Cyberpunk</option>
                    <option value="lcars">LCARS (Star Trek)</option>
                  </select>
                  <small id="auto-theme-hint" class="hidden" style="color: #888; display: block; margin-top: 4px;">Uses global schedule from Settings tab</small>
                </div>
                <div class="form-group">
                  <label>Brightness</label>
                  <div class="slider-container">
                    <input type="range" id="device-brightness" min="10" max="100" value="80">
                    <span class="slider-value" id="brightness-value">80%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">
                Buttons
                <button class="btn btn-sm btn-secondary" onclick="addButton()">+ Add Button</button>
              </div>
              <div class="button-list" id="button-list"></div>
            </div>

            <div class="section">
              <div class="collapsible-header collapsed" onclick="toggleCollapsible(this)">
                <div class="section-title">
                  <span class="collapse-icon">▼</span>
                  Import External Devices
                </div>
                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); discoverImportableDevices(); expandCollapsible(this.parentElement);">Discover Devices</button>
              </div>
              <div id="importable-devices-list" class="collapsible-content collapsed">
                <div class="empty-state" style="padding: 15px; color: #666;">Click "Discover Devices" to find devices from enabled plugins</div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">
                Scene Buttons
                <label class="toggle-switch">
                  <input type="checkbox" id="scenes-enabled" onchange="toggleScenes(this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="button-list" id="device-scene-list"></div>
            </div>

            <div class="section">
              <div class="collapsible-header collapsed" onclick="toggleCollapsible(this)">
                <div class="section-title">
                  <span class="collapse-icon">▼</span>
                  Brightness Schedule
                  <label class="toggle-switch" onclick="event.stopPropagation();">
                    <input type="checkbox" id="schedule-enabled" onchange="toggleScheduleEnabled(this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              <div class="collapsible-content collapsed" id="schedule-content">
                <div class="use-global-toggle">
                  <label>
                    Use Global Schedule
                    <small>Use the default brightness schedule from Settings instead of a custom schedule for this display</small>
                  </label>
                  <label class="toggle-switch">
                    <input type="checkbox" id="use-global-schedule" onchange="toggleUseGlobalSchedule(this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div id="device-schedule-settings">
                  <div class="form-group">
                    <label>Timezone</label>
                    <select id="schedule-timezone">
                      <option value="America/New_York">America/New_York (EST/EDT)</option>
                      <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                      <option value="America/Denver">America/Denver (MST/MDT)</option>
                      <option value="America/Phoenix">America/Phoenix (MST - no DST)</option>
                      <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                      <option value="America/Anchorage">America/Anchorage (AKST/AKDT)</option>
                      <option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option>
                      <option value="America/Toronto">America/Toronto (EST/EDT)</option>
                      <option value="America/Vancouver">America/Vancouver (PST/PDT)</option>
                      <option value="Europe/London">Europe/London (GMT/BST)</option>
                      <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                      <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                      <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                      <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                      <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                      <option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option>
                      <option value="UTC">UTC</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Touch Wake Brightness</label>
                    <div class="slider-container">
                      <input type="range" id="schedule-touch-brightness" min="10" max="100" value="30">
                      <span class="slider-value" id="schedule-touch-brightness-value">30%</span>
                    </div>
                    <small style="color: #888;">Brightness when tapping screen at 0%</small>
                  </div>
                  <div class="form-group">
                    <label>Display Timeout (seconds)</label>
                    <input type="number" id="schedule-display-timeout" min="5" max="300" value="30" style="width: 100px;">
                    <small style="color: #888;">How long to stay awake after touch</small>
                  </div>
                  <div class="form-group">
                    <label>Schedule Periods</label>
                    <div id="schedule-periods-list"></div>
                    <button class="btn btn-sm btn-secondary" onclick="addSchedulePeriod()" style="margin-top: 8px;">+ Add Period</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-success" onclick="saveDeviceConfig()">Save & Push to Display</button>
              <button class="btn btn-secondary" onclick="syncDeviceStates()">Sync States</button>
              <div class="actions-right">
                <button class="btn btn-danger" onclick="deleteDevice()">Remove Display</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="collapsible-header collapsed" onclick="toggleCollapsible(this)">
              <div class="section-title">
                <span class="collapse-icon">▼</span>
                Live Preview
              </div>
              <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); expandCollapsible(this.parentElement); captureScreenshot();">Capture</button>
            </div>
            <div class="collapsible-content collapsed" id="live-preview-content">
              <div class="info-grid" id="device-info"></div>
              <div class="screenshot-actions">
                <button class="btn btn-sm btn-secondary" onclick="captureScreenshot()">Capture New</button>
                <button class="btn btn-sm btn-secondary" onclick="refreshScreenshot()">Refresh</button>
              </div>
              <div class="screenshot-container">
                <div id="screenshot-spinner" class="spinner" style="display: none;"></div>
                <img id="device-screenshot" src="" alt="Display screenshot" style="display: none;">
                <div id="no-screenshot">Select a display to view screenshot</div>
              </div>
            </div>
          </div>
        </div>

        <div id="no-device-selected" class="card">
          <div class="empty-state">
            <p style="font-size: 1.2em; margin-bottom: 10px;">Select a display</p>
            <p>Choose a display from the list to configure it, or go to the Discover tab to add new displays.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scenes Tab -->
    <div id="tab-scenes" class="hidden">
      <div class="main-layout">
        <div>
          <div class="card">
            <h2>Global Scenes</h2>
            <button class="btn btn-primary btn-sm" onclick="createNewScene()" style="margin-bottom: 15px;">+ New Scene</button>
            <div id="scene-list">
              <div class="empty-state">Loading scenes...</div>
            </div>
          </div>
        </div>

        <div id="scene-editor" class="hidden">
          <div class="card">
            <div class="section">
              <div class="section-title">Scene Settings</div>
              <div class="form-row">
                <div class="form-group">
                  <label>Scene Name</label>
                  <input type="text" id="scene-name" placeholder="e.g., Goodnight">
                </div>
                <div class="form-group">
                  <label>Icon</label>
                  <select id="scene-icon">
                    <option value="bolt">Bolt</option>
                    <option value="bulb">Bulb</option>
                    <option value="ceiling_light">Ceiling Light</option>
                    <option value="ok">Check</option>
                    <option value="door">Door</option>
                    <option value="garage">Garage</option>
                    <option value="settings">Gear</option>
                    <option value="home">Home</option>
                    <option value="moon">Moon</option>
                    <option value="power">Power</option>
                    <option value="sleep">Sleep</option>
                    <option value="sun">Sun</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-title">
                Device Actions
                <button class="btn btn-sm btn-primary" onclick="openSceneDevicePicker()">+ Add Device</button>
              </div>
              <div id="scene-actions-list">
                <div class="empty-state" style="padding: 15px; color: #666;">Add devices to control when this scene is activated</div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-success" onclick="saveScene()">Save Scene</button>
              <button class="btn btn-secondary" onclick="testScene()">Test Scene</button>
              <div class="actions-right">
                <button class="btn btn-danger" onclick="deleteScene()">Delete Scene</button>
              </div>
            </div>
          </div>
        </div>

        <div id="no-scene-selected" class="card">
          <div class="empty-state">
            <p style="font-size: 1.2em; margin-bottom: 10px;">Select or create a scene</p>
            <p>Scenes let you control multiple devices with a single button press.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Discover Tab -->
    <div id="tab-discover" class="hidden">
      <div class="card">
        <h2>Discover New Displays</h2>
        <p style="color: #888; margin-bottom: 15px;">
          ESP32 displays advertising via mDNS will appear here. Click "Adopt" to add them to your system.
        </p>
        <button class="btn btn-primary" onclick="scanDevices()">Scan Network</button>
        <div id="discovered-list" style="margin-top: 20px;">
          <div class="empty-state">Click "Scan Network" to search for displays</div>
        </div>
      </div>
    </div>

    <!-- Plugins Tab -->
    <div id="tab-plugins" class="hidden">
      <div class="main-layout">
        <div>
          <div class="card">
            <h2>Installed Plugins</h2>
            <div id="plugin-list">
              <div class="empty-state">Loading plugins...</div>
            </div>
          </div>
        </div>

        <div id="plugin-config" class="hidden">
          <div class="card">
            <h2 id="plugin-config-title">Plugin Configuration</h2>
            <div id="plugin-config-form"></div>
            <div class="actions">
              <button class="btn btn-secondary" onclick="testPluginConnection()">Test Connection</button>
              <button class="btn btn-success" onclick="savePluginConfig()">Save Configuration</button>
            </div>
          </div>

          <div class="card" id="plugin-devices-card" class="hidden">
            <h2>Discovered Devices</h2>
            <button class="btn btn-primary btn-sm" onclick="discoverPluginDevices()" style="margin-bottom: 15px;">Refresh Devices</button>
            <div id="plugin-devices-list">
              <div class="empty-state">Click "Refresh Devices" to discover devices</div>
            </div>
          </div>

          <div id="plugin-custom-ui" class="hidden"></div>
        </div>

        <div id="no-plugin-selected" class="card">
          <div class="empty-state">
            <p style="font-size: 1.2em; margin-bottom: 10px;">Select a plugin</p>
            <p>Choose a plugin from the list to configure it and discover external devices.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="hidden">
      <h2 style="color: #00d4ff; margin-bottom: 5px;">Global Settings</h2>
      <p style="color: #888; margin-bottom: 20px;">Configure default settings that apply to all displays. Individual displays can override these settings.</p>

      <div class="settings-tabs">
        <div class="settings-tab active" data-settings-tab="brightness" onclick="switchSettingsTab('brightness')">Brightness</div>
        <div class="settings-tab" data-settings-tab="theme" onclick="switchSettingsTab('theme')">Light/Dark Mode</div>
      </div>

      <!-- Brightness Panel -->
      <div id="settings-panel-brightness" class="settings-panel active">
        <div class="settings-layout">
          <div class="card">
            <div class="section">
              <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <div class="section-title">
                  <span class="collapse-icon">▼</span>
                  Default Brightness Schedule
                  <label class="toggle-switch" onclick="event.stopPropagation();">
                    <input type="checkbox" id="global-schedule-enabled" onchange="toggleGlobalScheduleEnabled(this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              <div class="collapsible-content" id="global-schedule-content">
                <p style="color: #888; margin-bottom: 15px; font-size: 0.9em;">
                  This schedule will apply to all displays that have "Use Global Schedule" enabled in their individual settings.
                </p>
                <div class="form-group">
                  <label>Default Timezone</label>
                  <select id="global-schedule-timezone">
                    <option value="America/New_York">America/New_York (EST/EDT)</option>
                    <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                    <option value="America/Denver">America/Denver (MST/MDT)</option>
                    <option value="America/Phoenix">America/Phoenix (MST - no DST)</option>
                    <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                    <option value="America/Anchorage">America/Anchorage (AKST/AKDT)</option>
                    <option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option>
                    <option value="America/Toronto">America/Toronto (EST/EDT)</option>
                    <option value="America/Vancouver">America/Vancouver (PST/PDT)</option>
                    <option value="Europe/London">Europe/London (GMT/BST)</option>
                    <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                    <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                    <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                    <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                    <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                    <option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option>
                    <option value="UTC">UTC</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Touch Wake Brightness</label>
                  <div class="slider-container">
                    <input type="range" id="global-schedule-touch-brightness" min="10" max="100" value="30" oninput="document.getElementById('global-schedule-touch-brightness-value').textContent = this.value + '%'">
                    <span class="slider-value" id="global-schedule-touch-brightness-value">30%</span>
                  </div>
                  <small style="color: #888;">Brightness when tapping screen at 0%</small>
                </div>
                <div class="form-group">
                  <label>Display Timeout (seconds)</label>
                  <input type="number" id="global-schedule-display-timeout" min="5" max="300" value="30" style="width: 100px;">
                  <small style="color: #888;">How long to stay awake after touch</small>
                </div>
                <div class="form-group">
                  <label>Schedule Periods</label>
                  <div id="global-schedule-periods-list"></div>
                  <button class="btn btn-sm btn-secondary" onclick="addGlobalSchedulePeriod()" style="margin-top: 8px;">+ Add Period</button>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-success" onclick="saveGlobalSettings()">Save Brightness Settings</button>
            </div>
          </div>

          <div class="card">
            <h2>Display Schedule Overrides</h2>
            <p style="color: #888; margin-bottom: 15px;">Shows which displays are using the global brightness schedule and which have custom settings.</p>
            <div id="device-schedule-status-list">
              <div class="empty-state">Loading displays...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Light/Dark Mode Panel -->
      <div id="settings-panel-theme" class="settings-panel">
        <div class="settings-layout">
          <div class="card">
            <div class="section">
              <div class="section-title">Auto Light/Dark Schedule</div>
              <p style="color: #888; margin-bottom: 15px; font-size: 0.9em;">
                Configure the day and night themes. Devices set to "Auto Light/Dark" will use this schedule.
              </p>
              <div class="form-row" style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                  <label>Day Theme</label>
                  <select id="global-theme-day">
                    <option value="light_mode">Light Mode</option>
                    <option value="dark_mode">Dark Mode</option>
                    <option value="neon_cyberpunk">Neon Cyberpunk</option>
                    <option value="lcars">LCARS</option>
                  </select>
                  <small style="color: #888;">Theme used during daytime hours</small>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Night Theme</label>
                  <select id="global-theme-night">
                    <option value="dark_mode">Dark Mode</option>
                    <option value="light_mode">Light Mode</option>
                    <option value="neon_cyberpunk">Neon Cyberpunk</option>
                    <option value="lcars">LCARS</option>
                  </select>
                  <small style="color: #888;">Theme used during nighttime hours</small>
                </div>
              </div>
              <div class="form-row" style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                  <label>Day Starts At</label>
                  <select id="global-theme-day-start">
                    <option value="5">5:00 AM</option>
                    <option value="6">6:00 AM</option>
                    <option value="7" selected>7:00 AM</option>
                    <option value="8">8:00 AM</option>
                    <option value="9">9:00 AM</option>
                  </select>
                  <small style="color: #888;">When to switch to day theme</small>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Night Starts At</label>
                  <select id="global-theme-night-start">
                    <option value="18">6:00 PM</option>
                    <option value="19">7:00 PM</option>
                    <option value="20" selected>8:00 PM</option>
                    <option value="21">9:00 PM</option>
                    <option value="22">10:00 PM</option>
                  </select>
                  <small style="color: #888;">When to switch to night theme</small>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-success" onclick="saveGlobalSettings()">Save Theme Settings</button>
            </div>
          </div>

          <div class="card">
            <h2>Display Theme Overrides</h2>
            <p style="color: #888; margin-bottom: 15px;">Shows which displays are using the global theme schedule and which have custom settings.</p>
            <div id="device-theme-schedule-status-list">
              <div class="empty-state">Loading displays...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Adopt Modal -->
  <div id="adopt-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Adopt Display</h2>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="adopt-name" placeholder="e.g., Living Room Panel">
      </div>
      <div class="form-group">
        <label>Location</label>
        <input type="text" id="adopt-location" placeholder="e.g., Living Room">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeAdoptModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAdopt()">Adopt Display</button>
      </div>
    </div>
  </div>

  <!-- Import Device Modal -->
  <div id="import-modal" class="modal hidden">
    <div class="modal-content modal-lg">
      <h2>Import External Device</h2>
      <p style="color: #888; margin-bottom: 15px;">
        Select an external device to bind to this button. When the button is pressed, it will control the selected device.
      </p>
      <div class="form-group">
        <label>Plugin</label>
        <select id="import-plugin" onchange="loadImportDevices()">
          <option value="">Select a plugin...</option>
        </select>
      </div>
      <h3>Available Devices</h3>
      <div id="import-devices-list">
        <div class="empty-state">Select a plugin to see available devices</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Create Button from Import Modal -->
  <div id="create-button-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Create Button from External Device</h2>
      <div class="form-group">
        <label>Button Name</label>
        <input type="text" id="create-button-name" placeholder="e.g., Living Room Light">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Button Type</label>
          <select id="create-button-type">
            <option value="light">Light</option>
            <option value="switch">Switch</option>
            <option value="fan">Fan</option>
          </select>
        </div>
        <div class="form-group">
          <label>Icon</label>
          <select id="create-button-icon">
            <option value="charge">Light</option>
            <option value="fan">Fan</option>
            <option value="power">Power</option>
            <option value="home">Home</option>
            <option value="settings">Gear</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Bound Device</label>
        <div id="create-button-binding-info" style="padding: 10px; background: #0f0f1a; border-radius: 6px; color: #75b798; font-size: 0.9em;"></div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeCreateButtonModal()">Cancel</button>
        <button class="btn btn-success" onclick="confirmCreateButton()">Create Button</button>
      </div>
    </div>
  </div>

  <!-- Scene Device Picker Modal -->
  <div id="scene-device-picker-modal" class="modal hidden">
    <div class="modal-content modal-lg">
      <h2>Add Devices to Scene</h2>
      <p style="color: #888; margin-bottom: 15px;">
        Click devices to add them. You can add multiple devices before closing.
      </p>
      <div id="scene-device-picker-list">
        <div class="empty-state">Loading available devices...</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeSceneDevicePicker()">Done</button>
      </div>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>
</body>
</html>
